<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Account - VoxGen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --brand-50: #eef3ee;
      --brand-100: #dce7dc;
      --brand-200: #b9cfb9;
      --brand-300: #8fb48f;
      --brand-500: #4f8250;
      --brand-600: #3d7044;
      --brand-700: #2f5a34;
      --brand-800: #244828;

      --gray-50: #f8f5f1;
      --gray-100: #f0ebe4;
      --gray-200: #e4ded5;
      --gray-300: #cdc5b9;
      --gray-400: #a39c91;
      --gray-500: #7a756c;
      --gray-600: #5e5a53;
      --gray-700: #45423c;
      --gray-900: #1c1b18;

      --success-50: #ecfdf3;
      --success-500: #17b26a;
      --success-700: #067647;

      --warning-50: #fffaeb;
      --warning-500: #f79009;
      --warning-700: #b54708;

      --error-50: #fef3f2;
      --error-500: #f04438;
      --error-700: #b42318;

      --shadow-xs: 0 1px 2px rgba(28, 27, 24, 0.04);
      --shadow-sm: 0 1px 2px rgba(28, 27, 24, 0.05), 0 1px 3px rgba(28, 27, 24, 0.08);
      --shadow-md: 0 2px 4px -2px rgba(28, 27, 24, 0.05), 0 4px 8px -2px rgba(28, 27, 24, 0.08);
      --shadow-lg: 0 4px 6px -2px rgba(28, 27, 24, 0.02), 0 12px 16px -4px rgba(28, 27, 24, 0.06);

      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-2xl: 20px;
      --radius-full: 9999px;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      -webkit-font-smoothing: antialiased;
    }

    /* Ambient background */
    .bg-glow {
      position: fixed;
      inset: 0;
      z-index: -1;
      overflow: hidden;
      pointer-events: none;
    }
    .bg-glow::before {
      content: '';
      position: absolute;
      width: 700px;
      height: 700px;
      top: -250px;
      left: 50%;
      transform: translateX(-50%);
      background: radial-gradient(circle, rgba(61, 112, 68, 0.08) 0%, transparent 70%);
      animation: float 10s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(20px); }
    }

    .page {
      max-width: 480px;
      width: 100%;
      text-align: center;
    }

    /* Logo */
    .logo {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px;
      text-decoration: none;
      color: var(--gray-900);
      margin-bottom: 40px;
      transition: transform 0.2s ease;
    }
    .logo:hover { transform: translateY(-1px); }
    .logo-icon {
      width: 38px;
      height: 38px;
      background: var(--brand-700);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.25;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
      color: var(--gray-900);
    }
    .subtitle {
      font-size: 15px;
      color: var(--gray-500);
      margin-bottom: 28px;
    }

    /* Card */
    .card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-2xl);
      padding: 32px;
      box-shadow: var(--shadow-sm);
      text-align: center;
    }

    /* Form */
    .form-group {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }
    .email-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      font-size: 15px;
      font-family: inherit;
      background: var(--gray-50);
      color: var(--gray-900);
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .email-input:focus {
      border-color: var(--brand-500);
      box-shadow: 0 0 0 3px rgba(79, 130, 80, 0.12);
    }
    .email-input::placeholder { color: var(--gray-400); }

    .check-btn {
      padding: 12px 24px;
      border-radius: var(--radius-lg);
      font-size: 15px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      border: none;
      background: var(--brand-600);
      color: white;
      box-shadow: var(--shadow-xs);
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .check-btn:hover {
      background: var(--brand-700);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    .check-btn:active { transform: translateY(0); }
    .check-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Loading */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--brand-600);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: -2px;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Result cards */
    .result {
      margin-top: 20px;
      text-align: left;
      border-radius: var(--radius-lg);
      padding: 20px;
      display: none;
    }
    .result.visible { display: block; }

    .result-active {
      background: var(--success-50);
      border: 1px solid rgba(23, 178, 106, 0.3);
    }
    .result-inactive {
      background: var(--warning-50);
      border: 1px solid rgba(247, 144, 9, 0.3);
    }
    .result-notfound {
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
    }
    .result-error {
      background: var(--error-50);
      border: 1px solid rgba(240, 68, 56, 0.3);
    }

    .result-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .result-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    .result-title {
      font-size: 15px;
      font-weight: 600;
    }
    .result-body {
      font-size: 14px;
      color: var(--gray-600);
      line-height: 1.5;
    }
    .result-body p { margin-bottom: 8px; }
    .result-body p:last-child { margin-bottom: 0; }

    /* Plan info inside active result */
    .plan-box {
      background: white;
      border: 1px solid rgba(23, 178, 106, 0.2);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      margin: 12px 0 16px;
    }
    .plan-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--gray-500);
      margin-bottom: 4px;
    }
    .plan-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--brand-700);
    }
    .plan-expiry {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    /* Action buttons inside results */
    .result-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      border: none;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    .action-btn:hover { transform: translateY(-1px); }
    .action-btn:active { transform: translateY(0); }
    .action-btn svg { width: 16px; height: 16px; }

    .action-btn-primary {
      background: var(--brand-600);
      color: white;
      box-shadow: var(--shadow-xs);
    }
    .action-btn-primary:hover { background: var(--brand-700); }

    .action-btn-secondary {
      background: white;
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-xs);
    }
    .action-btn-secondary:hover { background: var(--gray-50); border-color: var(--gray-300); }

    /* Links */
    .result-link {
      color: var(--brand-600);
      text-decoration: none;
      font-weight: 600;
    }
    .result-link:hover { text-decoration: underline; }

    .footer-link {
      margin-top: 24px;
      font-size: 14px;
      color: var(--gray-400);
    }
    .footer-link a {
      color: var(--brand-600);
      text-decoration: none;
      font-weight: 500;
    }
    .footer-link a:hover { text-decoration: underline; }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 20px;
      color: var(--gray-400);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.15s ease;
    }
    .back-link:hover { color: var(--gray-600); }
    .back-link svg { width: 16px; height: 16px; }

    @media (max-width: 560px) {
      .page { padding: 0; }
      .card { padding: 24px 20px; border-radius: var(--radius-xl); }
      h1 { font-size: 24px; }
      .form-group { flex-direction: column; }
      .check-btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>

<div class="bg-glow"></div>

<div class="page">
  <a href="index.html" class="logo">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
    </div>
    VoxGen
  </a>

  <h1>Check Your License</h1>
  <p class="subtitle">Enter the email you used at purchase to check your license status.</p>

  <div class="card">
    <div class="form-group">
      <input type="email" class="email-input" id="email-input" placeholder="you@example.com" autocomplete="email" />
      <button class="check-btn" id="check-btn" onclick="checkLicense()">Check Status</button>
    </div>

    <!-- Active license -->
    <div class="result result-active" id="result-active">
      <div class="result-header">
        <svg class="result-icon" viewBox="0 0 24 24" fill="none" stroke="#067647" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span class="result-title" style="color: var(--success-700)">Active License</span>
      </div>
      <div class="plan-box">
        <div class="plan-label">Your Plan</div>
        <div class="plan-name" id="active-plan"></div>
        <div class="plan-expiry" id="active-expiry"></div>
      </div>
      <div class="result-body">
        <p>Your license is active and ready to use.</p>
      </div>
      <div class="result-actions">
        <a href="#" class="action-btn action-btn-primary" id="activate-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
          Activate in VoxGen
        </a>
        <button class="action-btn action-btn-secondary" id="billing-btn" onclick="openBilling()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
          Manage Billing
        </button>
      </div>
    </div>

    <!-- No active license (account exists) -->
    <div class="result result-inactive" id="result-inactive">
      <div class="result-header">
        <svg class="result-icon" viewBox="0 0 24 24" fill="none" stroke="#b54708" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        <span class="result-title" style="color: var(--warning-700)" id="inactive-title">No Active License</span>
      </div>
      <div class="result-body" id="inactive-body">
        <p>Your account was found but doesn't have an active plan. This can happen if a subscription was cancelled or a payment didn't go through.</p>
        <p><a href="index.html#pricing" class="result-link">Renew or upgrade your plan</a> to reactivate.</p>
      </div>
    </div>

    <!-- No license found -->
    <div class="result result-notfound" id="result-notfound">
      <div class="result-header">
        <svg class="result-icon" viewBox="0 0 24 24" fill="none" stroke="#5e5a53" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <span class="result-title" style="color: var(--gray-700)">No License Found</span>
      </div>
      <div class="result-body">
        <p>We couldn't find a license for this email. Make sure you're using the same email address from your purchase confirmation.</p>
        <p>Purchased with a different email? Try checking with that address instead.</p>
        <p style="margin-top: 12px">Don't have a license yet? <a href="index.html#pricing" class="result-link">View plans</a></p>
      </div>
    </div>

    <!-- Error -->
    <div class="result result-error" id="result-error">
      <div class="result-header">
        <svg class="result-icon" viewBox="0 0 24 24" fill="none" stroke="#b42318" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>
        <span class="result-title" style="color: var(--error-700)">Something went wrong</span>
      </div>
      <div class="result-body">
        <p id="error-message">Failed to check license status. Please check your internet connection and try again.</p>
      </div>
      <div class="result-actions">
        <button class="action-btn action-btn-secondary" onclick="checkLicense()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          Try Again
        </button>
      </div>
    </div>
  </div>

  <p class="footer-link">Don't have a license? <a href="index.html#pricing">View pricing</a></p>

  <a href="index.html" class="back-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    Back to VoxGen
  </a>
</div>

<script>
  var emailInput = document.getElementById('email-input');
  var checkBtn = document.getElementById('check-btn');

  // Allow Enter key to submit
  emailInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') checkLicense();
  });

  // Pre-fill email from URL param (e.g., account.html?email=user@example.com)
  var params = new URLSearchParams(window.location.search);
  var prefillEmail = params.get('email');
  if (prefillEmail) {
    emailInput.value = prefillEmail;
    // Auto-check after short delay
    setTimeout(checkLicense, 500);
  }

  function hideAllResults() {
    document.querySelectorAll('.result').forEach(function(el) {
      el.classList.remove('visible');
    });
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  var currentEmail = '';

  async function checkLicense() {
    var email = emailInput.value.trim().toLowerCase();
    if (!email || !email.includes('@')) return;

    currentEmail = email;
    checkBtn.disabled = true;
    checkBtn.innerHTML = '<span class="spinner"></span> Checking';
    hideAllResults();

    try {
      var resp = await fetch('/api/validate-license', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email })
      });
      var data = await resp.json();

      if (data.valid) {
        // Active license found
        document.getElementById('active-plan').textContent = data.plan || 'Pro';
        var expiryEl = document.getElementById('active-expiry');
        if (data.expiresAt) {
          expiryEl.textContent = 'Expires: ' + new Date(data.expiresAt).toLocaleDateString();
        } else {
          expiryEl.textContent = 'Never expires';
        }

        // Set up deep link
        var deepLink = 'voxgen://activate?email=' + encodeURIComponent(email);
        document.getElementById('activate-link').href = deepLink;

        // Show/hide billing button (lifetime licenses have no recurring billing)
        var billingBtn = document.getElementById('billing-btn');
        billingBtn.style.display = (data.planSlug === 'lifetime' || data.planSlug === 'free') ? 'none' : '';

        document.getElementById('result-active').classList.add('visible');
      } else if (data.error && data.error.indexOf('No license found') !== -1) {
        // Email doesn't exist in system
        document.getElementById('result-notfound').classList.add('visible');
      } else if (data.error && data.error.indexOf('expired') !== -1) {
        // License expired
        document.getElementById('inactive-title').textContent = 'License Expired';
        document.getElementById('inactive-body').innerHTML =
          '<p>Your license has expired. <a href="index.html#pricing" class="result-link">Renew your plan</a> to continue using managed API keys.</p>';
        document.getElementById('result-inactive').classList.add('visible');
      } else {
        // No active license (account exists but cancelled/pending)
        document.getElementById('inactive-title').textContent = 'No Active License';
        document.getElementById('inactive-body').innerHTML =
          '<p>Your account was found but doesn\'t have an active plan. This can happen if a subscription was cancelled or a payment didn\'t go through.</p>' +
          '<p><a href="index.html#pricing" class="result-link">Renew or upgrade your plan</a> to reactivate.</p>';
        document.getElementById('result-inactive').classList.add('visible');
      }
    } catch (err) {
      document.getElementById('error-message').textContent = 'Failed to check license status. Please check your internet connection and try again.';
      document.getElementById('result-error').classList.add('visible');
    } finally {
      checkBtn.disabled = false;
      checkBtn.textContent = 'Check Status';
    }
  }

  async function openBilling() {
    if (!currentEmail) return;
    var billingBtn = document.getElementById('billing-btn');
    billingBtn.disabled = true;
    billingBtn.innerHTML = '<span class="spinner"></span> Opening...';

    try {
      var resp = await fetch('/api/customer-portal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: currentEmail })
      });
      var data = await resp.json();

      if (data.url) {
        window.open(data.url, '_blank');
      } else {
        alert(data.error || 'Could not open billing portal. Lifetime licenses do not have recurring billing.');
      }
    } catch (err) {
      alert('Failed to open billing portal. Please check your internet connection.');
    } finally {
      billingBtn.disabled = false;
      billingBtn.innerHTML =
        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>' +
        ' Manage Billing';
    }
  }
</script>
</body>
</html>
